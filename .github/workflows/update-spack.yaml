name: Update spack develop version

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  bundle:
    runs-on: ubuntu-latest
    container:
      image: stabbles/spack-old-glibc
    steps:
      - uses: actions/checkout@v2
      - name: Create new spack.x
        run: |
          # Download the latest stable spack.x release and the latest runtime.x
          curl -Ls -o spack.x https://github.com/haampie/spack-batteries-included/releases/download/v1.0.5/spack.x
          curl -Ls -o runtime.x https://github.com/haampie/spack-batteries-included/releases/download/v1.0.5/runtime.x
          chmod +x spack.x runtime.x

          # Get the SHA of the latest spack release
          export SPACK_SHA=$(git ls-remote https://github.com/spack/spack.git | grep refs/heads/develop | head -n1 | awk '{ print $1}')

          # Extract them.
          mkdir spack_x runtime_x
          cd spack_x
          ../spack.x --appimage-extract 1> /dev/null
          cd ..
          cd runtime_x
          ../runtime.x --appimage-extract 1> /dev/null
          cd ..

          # Replace the spack version
          rm -rf spack_x/squashfs-root/spack
          mkdir spack_x/squashfs-root/spack
          curl -Ls "https://api.github.com/repos/spack/spack/tarball/$SPACK_SHA" | tar --strip-components=1 -xz -C spack_x/squashfs-root/spack
          
          # Let's store the the spack SHA in here too
          echo $SPACK_SHA > spack_x/squashfs-root/spack_sha

          # Apply the patch that allows you to drop specifying --log-file
          cd spack_x/squashfs-root/spack
          git apply $GITHUB_WORKSPACE/bootstrap-spack/20158.patch
          cp $GITHUB_WORKSPACE/bootstrap-spack/config.yaml etc/spack/
          cd ../../..

          # Generate __pycache__ files
          cd spack_x/squashfs-root
          find . -iname "__pycache__" | xargs rm -rf
          ./AppRun python -m compileall install/ spack/ 1> /dev/null || true
          cd ../..

          # Create a new squashfs file
          ./runtime_x/squashfs-root/view/bin/mksquashfs spack_x/squashfs-root spack.squashfs

          # Overwrite spack.x
          cat runtime_x/squashfs-root/runtime spack.squashfs > spack.x
      - name: Upload spack.x
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: spack.x
          asset_name: spack.x
          tag: develop
          overwrite: true
          body: "Automatically updating release"
      - name: Upload spack.squashfs
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: spack.squashfs
          asset_name: spack.squashfs
          tag: develop
          overwrite: true
          body: "Automatically updating release"



