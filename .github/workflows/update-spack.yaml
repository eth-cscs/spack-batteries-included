name: Update spack develop version

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  bundle:
    runs-on: ubuntu-latest
    container:
      image: stabbles/spack-old-glibc
    steps:
      - uses: actions/checkout@v2
      - name: Create new spack.x
        run: |
          # Download the latest stable spack.x release and the latest runtime.x
          curl -Ls -o spack.x https://github.com/haampie/spack-batteries-included/releases/download/v1.2.1/spack.x
          curl -Ls -o runtime.x https://github.com/haampie/spack-batteries-included/releases/download/v1.2.1/runtime.x
          chmod +x spack.x runtime.x

          # Get the SHA of the latest spack release
          export SPACK_SHA=$(git ls-remote https://github.com/spack/spack.git | grep refs/heads/develop | head -n1 | awk '{ print $1}')

          # Extract them.
          mkdir spack_x runtime_x
          cd spack_x
          ../spack.x --appimage-extract 1> /dev/null
          cd ..
          cd runtime_x
          ../runtime.x --appimage-extract 1> /dev/null
          cd ..

          # Replace the spack version
          rm -rf spack_x/squashfs-root/spack
          mkdir spack_x/squashfs-root/spack
          curl -Ls "https://api.github.com/repos/spack/spack/tarball/$SPACK_SHA" | tar --strip-components=1 -xz -C spack_x/squashfs-root/spack
          
          # Let's store the the spack SHA in here too
          echo $SPACK_SHA > spack_x/squashfs-root/spack_sha

          # Apply the patch that allows you to drop specifying --log-file
          cd spack_x/squashfs-root/spack
          git apply $GITHUB_WORKSPACE/bootstrap-spack/20158.patch
          cp $GITHUB_WORKSPACE/bootstrap-spack/config.yaml etc/spack/
          cd ../../..

          # Generate __pycache__ files
          cd spack_x/squashfs-root
          find . -iname "__pycache__" | xargs rm -rf
          ./AppRun python -m compileall spack/ 1> /dev/null || true
          cd ../..

          # Create a new squashfs file
          ./runtime_x/squashfs-root/view/bin/mksquashfs spack_x/squashfs-root spack.squashfs

          # Overwrite spack.x
          cat runtime_x/squashfs-root/runtime spack.squashfs > spack.x
      - name: Upload release assets
        run: |
          curl -fsS \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/haampie/spack-batteries-included/releases > release_info.json

          for name in spack.x spack.squashfs
          do
            # Get the release url
            release_url="$(< release_info.json jq -r '.[] | select(.tag_name=="develop") | .url')"

            # Get the asset url
            asset_url="$(< release_info.json jq -r --arg name "$name" '.[] | select(.tag_name=="develop") | .assets[] | select(.name==$name) | .url')"

            # Delete the asset
            if [ -n "$asset_url" ]; then
              curl -fsS \
                -X DELETE \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "$asset_url"
            fi

            # Upload a new one.
            curl -fsS \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              --data-binary @$name \
              "$release_url/assets?name=$name"
          done



