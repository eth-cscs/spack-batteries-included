name: Update spack develop version

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  bundle:
    runs-on: ubuntu-latest
    steps:
      - name: Create new spack.x
        run: |
          # Get the SHA of the latest spack release
          export SPACK_SHA=$(git ls-remote https://github.com/spack/spack.git | grep refs/heads/develop | head -n1 | awk '{ print $1}')
          echo "Using spack SHA $SPACK_SHA"

          # Download the latest stable spack.x release and the latest runtime.x
          export BASE_VERSION="v1.2.1"
          echo "Downloading spack.x and runtime.x from version $BASE_VERSION"
          curl -LfSs -o spack.x "https://github.com/haampie/spack-batteries-included/releases/download/$BASE_VERSION/spack.x"
          curl -LfSs -o runtime.x "https://github.com/haampie/spack-batteries-included/releases/download/$BASE_VERSION/runtime.x"
          echo "5477933a5225576ea364f9510a6981dfce36cda9c94125691a78df93c1011d65 spack.x" | sha256sum --check --status
          echo "6315ec43508550cb1896ef2da5d0bec2274715aa13ca9fad73da23dd53c65772 runtime.x" | sha256sum --check --status
          chmod +x spack.x runtime.x

          # Download spack patches
          echo "Downloading patches / files"
          curl -LSsf "https://github.com/haampie/spack-batteries-included/raw/$BASE_VERSION/bootstrap-spack/20158.patch" > 20158.patch
          curl -LSsf "https://github.com/haampie/spack-batteries-included/blob/master/bootstrap-spack/config.yaml" > config.yaml
          echo "4e0624b1c4527429f36aa5cff12266b4611f228731e3a01be1f06e075daf6571 20158.patch" | sha256sum --check --status
          echo "6486badd717f32b8fd9bc21ecdf71ce9ca7be2dd0a2be147613840ab116f3b6f config.yaml" | sha256sum --check --status

          # Extract them.
          echo "Extracting spack.x and runtime.x $BASE_VERSION"
          mkdir spack_x runtime_x
          cd spack_x
          ../spack.x --appimage-extract 1> /dev/null
          cd ..
          cd runtime_x
          ../runtime.x --appimage-extract 1> /dev/null
          cd ..

          # Replace the spack version
          echo "Download Spack $SPACK_SHA"
          rm -rf spack_x/squashfs-root/spack
          mkdir spack_x/squashfs-root/spack
          curl -LfSs "https://api.github.com/repos/spack/spack/tarball/$SPACK_SHA" | tar --strip-components=1 -xz -C spack_x/squashfs-root/spack
          echo $SPACK_SHA > spack_x/squashfs-root/spack_sha

          # Apply the patch that allows you to drop specifying --log-file
          cd spack_x/squashfs-root/spack
          patch -p1 $GITHUB_WORKSPACE/20158.patch
          cp $GITHUB_WORKSPACE/config.yaml etc/spack/
          cd ../../..

          # Generate __pycache__ files
          cd spack_x/squashfs-root
          find . -iname "__pycache__" | xargs rm -rf
          ./AppRun python -m compileall spack/ 1> /dev/null || true
          cd ../..

          # Create a new squashfs file
          ./runtime_x/squashfs-root/view/bin/mksquashfs spack_x/squashfs-root spack.squashfs

          # Overwrite spack.x
          cat runtime_x/squashfs-root/runtime spack.squashfs > spack.x
      - name: Upload release assets
        run: |
          curl -fsS \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/haampie/spack-batteries-included/releases > release_info.json

          for name in spack.x spack.squashfs
          do
            # Get the release url
            release_url="$(< release_info.json jq -r '.[] | select(.tag_name=="develop") | .url')"

            # Get the asset url
            asset_url="$(< release_info.json jq -r --arg name "$name" '.[] | select(.tag_name=="develop") | .assets[] | select(.name==$name) | .url')"

            # Delete the asset
            if [ -n "$asset_url" ]; then
              echo "Deleting remote $name"
              curl -fsS \
                -X DELETE \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "$asset_url"
            fi

            # Upload a new one.
            echo "Uploading new $name"
            curl -fsS \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              --data-binary @$name \
              "$release_url/assets?name=$name"
          done



